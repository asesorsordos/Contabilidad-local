<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contabilidad Online</title>
    <!-- Bootstrap CSS -->
    <link href="./libs/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .container {
            max-width: 1000px;
        }
        .receipt {
            border: 1px solid #dee2e6;
            padding: 2rem;
            background-color: #fff;
        }
        .receipt-header {
            text-align: center;
            margin-bottom: 2rem;
            border-bottom: 2px solid #000;
            padding-bottom: 1rem;
        }
        .receipt-body p {
            font-size: 1.1rem;
        }
        @media print {
            body * {
                visibility: hidden;
            }
            .print-section, .print-section * {
                visibility: visible;
            }
            .print-section {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .modal-footer {
                display: none;
            }
            .modal-header .btn-close { display: none; }
        }
        /* --- Mejoras Visuales --- */
        /* Resaltar tarjetas de resumen al pasar el mouse */
        .card.bg-success:hover, .card.bg-danger:hover, .card.bg-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
            transition: all 0.2s ease-out;
        }
        /* Resaltar campos de formulario al enfocarlos */
        .form-control:focus, .form-select:focus {
            background-color: #eef5ff;
        }

        /* --- Dark Mode Styles --- */
        body.dark-mode {
            background-color: #1a1a1a; /* Más oscuro para mayor contraste */
            color: #e9ecef; /* Texto más claro */
        }
        body.dark-mode .card {
            background-color: #2b2b2b; /* Un poco más claro que el fondo */
            border-color: #444;
        }
        body.dark-mode .card-header, body.dark-mode .modal-header, body.dark-mode .modal-footer, body.dark-mode .border-top {
            border-color: #444 !important;
        }
        body.dark-mode .table {
            color: #e9ecef;
        }
        body.dark-mode .table-striped > tbody > tr:nth-of-type(odd) > * {
            background-color: rgba(255, 255, 255, 0.07); /* Rayas de tabla más visibles */
        }
        body.dark-mode .table-hover > tbody > tr:hover > * {
            background-color: rgba(255, 255, 255, 0.1); /* Hover de tabla más visible */
        }
        body.dark-mode .form-control, body.dark-mode .form-select {
            background-color: #3a3a3a;
            color: #fff;
            border-color: #555;
        }
        body.dark-mode .form-control::placeholder {
            color: #999;
        }
        body.dark-mode .form-control:focus, body.dark-mode .form-select:focus {
            background-color: #3a3a3a;
            border-color: #0d6efd; /* Resaltar foco con color primario de Bootstrap */
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }
        body.dark-mode .input-group-text {
            background-color: #3a3a3a;
            border-color: #555;
            color: #e9ecef;
        }
        body.dark-mode .text-muted {
            color: #999 !important;
        }
        body.dark-mode .modal-content {
            background-color: #2b2b2b;
        }
        body.dark-mode .btn-close {
            filter: invert(1) grayscale(100%) brightness(200%);
        }
        body.dark-mode .bg-light {
            background-color: #383838 !important;
            color: #fff !important;
        }
        body.dark-mode .btn-outline-secondary {
            color: #e9ecef;
            border-color: #555;
        }
        body.dark-mode .btn-outline-secondary:hover {
            background-color: #3a3a3a;
            color: #fff;
        }

        /* Ocultar flechas de aumento/disminución en campos de número */
        input[type=number] {
        }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0;
        }
    </style>
</head>
<body>

    <div class="container mt-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="mb-0">Sistema de Contabilidad Local</h1>
            <button id="theme-toggle" class="btn btn-outline-secondary btn-sm">Cambiar Tema</button>
        </div>
 
        <!-- Reportes y Totales -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4 id="totals-title" class="mb-0">Resumen General</h4>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-4 mb-3 mb-md-0">
                        <div class="card text-white bg-success">
                            <div class="card-body">
                                <h4 class="card-title">Total Ingresos</h4>
                        <p class="card-text fs-4 fw-bold" id="total-income">$0</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3 mb-md-0">
                        <div class="card text-white bg-danger">
                            <div class="card-body">
                                <h4 class="card-title">Total Egresos</h4>
                        <p class="card-text fs-4 fw-bold" id="total-expenses">$0</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-white bg-primary">
                            <div class="card-body">
                                <h4 class="card-title">Saldo Total</h4>
                        <p class="card-text fs-4 fw-bold" id="total-balance">$0</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard de Fondos (Colapsable) -->
        <div class="mb-4">
            <p>
                <a class="btn btn-outline-primary w-100" data-bs-toggle="collapse" href="#fundsDashboardCollapse" role="button" aria-expanded="false" aria-controls="fundsDashboardCollapse">
                    Ver/Ocultar Dashboard de Fondos
                </a>
            </p>
            <div class="collapse" id="fundsDashboardCollapse">
                <div class="card card-body">
                    <h4 class="mb-3 text-center">Saldos por Fondo</h4>
                    <div class="row" id="funds-dashboard">
                        <!-- Las tarjetas de fondos se insertarán aquí con JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Formulario de Ingreso -->
        <div class="card mb-5">
            <div class="card-header">
                <h3 id="form-title">Ingresar Asiento Contable</h3>
            </div>
            <div class="card-body">
                <form id="accounting-form">
                    <input type="hidden" id="edit-id">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label for="date" class="form-label">Fecha</label>
                            <input type="date" class="form-control" id="date" required>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="receipt-number" class="form-label">Nro. Recibo</label>
                            <input type="text" class="form-control" id="receipt-number" placeholder="Opcional">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="concept" class="form-label">Concepto</label>
                            <input type="text" class="form-control" id="concept" placeholder="Ej: Ofrenda, Donación, Compra de sillas" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label for="person" class="form-label">Recibido de / Pagado a</label>
                            <input type="text" class="form-control" id="person" placeholder="Nombre de la persona o entidad" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label for="type" class="form-label">Tipo de Movimiento</label>
                            <select id="type" class="form-select" required>
                                <option value="Ingreso">Ingreso</option>
                                <option value="Egreso">Egreso</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="amount" class="form-label">Monto</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="amount" min="0" placeholder="0" required>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <label for="fund" class="form-label mb-0">Fondo Asignado</label>
                                <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#manageFundsModal">Gestionar</button>
                            </div>
                            <select id="fund" class="form-select" required>
                                <!-- Las opciones se llenarán con JS -->
                            </select>
                        </div>
                    </div>
                    <button type="submit" id="form-submit-button" class="btn btn-primary">Guardar Asiento</button>
                </form>
            </div>
        </div>

        <!-- Historial de Asientos -->
        <div class="row align-items-center mb-3 gy-2">
            <div class="col-lg-4">
                <h2 class="mb-0">Historial de Asientos</h2>
            </div>
            <div class="col-lg-8">
                <div class="d-flex flex-wrap align-items-center justify-content-start justify-content-lg-end">
                    <div class="me-2 mb-2 mb-md-0">
                        <label for="fund-filter" class="form-label-sm me-1">Fondo:</label>
                        <select id="fund-filter" class="form-select form-select-sm w-auto d-inline-block">
                            <option value="all">Todos los Fondos</option>
                            <!-- Opciones se llenarán con JS -->
                        </select>
                    </div>
                    <div class="me-2 mb-2 mb-md-0">
                        <label for="type-filter" class="form-label-sm me-1">Tipo:</label>
                        <select id="type-filter" class="form-select form-select-sm w-auto d-inline-block">
                            <option value="all">Todos los Tipos</option>
                            <option value="Ingreso">Ingresos</option>
                            <option value="Egreso">Egresos</option>
                        </select>
                    </div>
                    <button class="btn btn-info btn-sm me-2 mb-2 mb-md-0" title="Realizar conteo de efectivo" onclick="openCashReconciliation()">Arqueo de Caja</button>
                    <button class="btn btn-secondary btn-sm me-2 mb-2 mb-md-0" title="Exportar vista actual a CSV" onclick="exportToCSV()">Exportar</button>
                    <button class="btn btn-danger btn-sm" title="Eliminar todos los registros permanentemente" onclick="clearHistory()">Limpiar Historial</button>
                </div>
            </div>
        </div>
        <div class="card mb-5">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Nro. Recibo</th>
                                <th>Concepto</th>
                                <th>Recibido de / Pagado a</th>
                                <th>Tipo</th>
                                <th>Monto</th>
                                <th>Fondo</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="history-table-body">
                            <!-- Las filas se insertarán aquí con JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <footer class="text-center text-muted py-4 border-top">
            <a href="#" data-bs-toggle="modal" data-bs-target="#documentationModal">
                Ver Uso y Características
            </a>
        </footer>
    </div>

    <!-- Modal para el Recibo -->
    <div class="modal fade" id="receiptModal" tabindex="-1" aria-labelledby="receiptModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="receiptModalLabel">Recibo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="receipt-content">
                    <!-- El contenido del recibo se generará aquí -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" onclick="printContent('receipt-content')">Imprimir Recibo</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Arqueo de Caja -->
    <div class="modal fade" id="cashReconciliationModal" tabindex="-1" aria-labelledby="cashReconciliationModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="cashReconciliationModalLabel">Arqueo de Caja</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="reconciliation-print-area">
                        <h3 class="text-center mb-4">Arqueo de Caja</h3>
                        <div class="row mb-3">
                            <div class="col-6">
                                <h5>Saldo en Sistema:</h5>
                                <p class="fs-4 fw-bold" id="system-balance">$0</p>
                            </div>
                            <div class="col-6">
                                <h5>Diferencia:</h5>
                                <p class="fs-4 fw-bold" id="balance-difference">$0</p>
                            </div>
                        </div>
                        <h5>Conteo de Efectivo Físico</h5>
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Denominación</th>
                                        <th>Cantidad</th>
                                        <th>Subtotal</th>
                                    </tr>
                                </thead>
                                <tbody id="denomination-table">
                                    <!-- Filas generadas por JS -->
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <th colspan="2" class="text-end">Total Efectivo Físico:</th>
                                        <th id="physical-total">$0</th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" onclick="printContent('reconciliation-print-area')">Imprimir Arqueo</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Documentación -->
    <div class="modal fade" id="documentationModal" tabindex="-1" aria-labelledby="documentationModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="documentationModalLabel">Ayuda y Documentación</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h4>Características Principales</h4>
                    <ul class="list-group mb-4">
                        <li class="list-group-item"><strong>Gestión de Asientos:</strong> Crear, editar y visualizar asientos contables.</li>
                        <li class="list-group-item"><strong>Resumen Financiero:</strong> Visualiza totales de ingresos, egresos y el saldo en tiempo real.</li>
                        <li class="list-group-item"><strong>Filtrado por Fondos:</strong> Filtra los asientos y los totales por fondos específicos.</li>
                        <li class="list-group-item"><strong>Generación de Recibos:</strong> Genera e imprime recibos detallados.</li>
                        <li class="list-group-item"><strong>Arqueo de Caja:</strong> Herramienta para facilitar el conteo de efectivo.</li>
                        <li class="list-group-item"><strong>Exportación a CSV:</strong> Exporta la vista actual a un archivo `.csv`.</li>
                        <li class="list-group-item"><strong>Persistencia de Datos:</strong> Los datos se guardan localmente en tu navegador.</li>
                    </ul>

                    <h4>¿Cómo usarlo?</h4>
                    <p>La aplicación está diseñada para ser intuitiva. Sigue estos pasos para comenzar:</p>
                    <ol class="list-group list-group-numbered mb-4">
                        <li class="list-group-item">Usa el formulario "Nuevo Asiento Contable" para registrar ingresos o egresos.</li>
                        <li class="list-group-item">Los registros aparecerán en el "Historial de Asientos".</li>
                        <li class="list-group-item">Usa los botones en el historial para "Editar" o "Ver Recibo" de una transacción.</li>
                        <li class="list-group-item">Filtra por fondo o usa las herramientas como "Arqueo de Caja" y "Exportar" según necesites.</li>
                    </ol>

                    <div class="alert alert-warning" role="alert">
                        <h4 class="alert-heading">¡Importante! Sobre el Almacenamiento de Datos</h4>
                        <p>Esta aplicación utiliza el almacenamiento local (`localStorage`) de tu navegador. Esto significa:</p>
                        <hr>
                        <ul>
                            <li>Los datos son locales: La información se almacena <strong>únicamente en la computadora y el navegador</strong> que estás utilizando. No se sincroniza entre dispositivos.</li>
                            <li><strong>Riesgo de pérdida de datos:</strong> Si limpias los datos de tu navegador (caché, historial, etc.), <strong>perderás toda la información contable registrada</strong>.</li>
                            <li>Se recomienda encarecidamente utilizar la función <strong>"Exportar"</strong> de forma regular para crear copias de seguridad.</li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Entendido</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Gestionar Fondos -->
    <div class="modal fade" id="manageFundsModal" tabindex="-1" aria-labelledby="manageFundsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="manageFundsModalLabel">Gestionar Fondos</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="new-fund-name" class="form-label">Añadir Nuevo Fondo</label>
                        <div class="input-group">
                            <input type="text" id="new-fund-name" class="form-control" placeholder="Nombre del nuevo fondo">
                            <button class="btn btn-primary" type="button" id="add-fund-btn">Añadir</button>
                        </div>
                    </div>
                    <hr>
                    <h6>Fondos Existentes</h6>
                    <ul class="list-group" id="funds-list">
                        <!-- La lista de fondos se generará aquí -->
                    </ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="./libs/js/bootstrap.bundle.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('accounting-form');
            const historyTableBody = document.getElementById('history-table-body');
            const receiptModal = new bootstrap.Modal(document.getElementById('receiptModal'));
            const receiptContent = document.getElementById('receipt-content');
            const formTitle = document.getElementById('form-title');
            const formSubmitButton = document.getElementById('form-submit-button');
            const fundFilter = document.getElementById('fund-filter');
            const typeFilter = document.getElementById('type-filter');
            const totalsTitle = document.getElementById('totals-title');
            const cashReconciliationModal = new bootstrap.Modal(document.getElementById('cashReconciliationModal'));
            const fundSelect = document.getElementById('fund');
            const themeToggle = document.getElementById('theme-toggle');
            const body = document.body;
            const manageFundsModalEl = document.getElementById('manageFundsModal');

            const defaultFunds = [
                "Fondo Local", "Asamblea", "Caballeros", "Construcción", 
                "Culto de sector", "Dorcas", "EVB", "Escuela Dominical", 
                "Jóvenes", "Misiones", "Música", "Obra Social"
            ];

            // --- Gestión de Fondos ---
            const getFunds = () => {
                const fundsJSON = localStorage.getItem('accountingFunds');
                if (fundsJSON) {
                    const funds = JSON.parse(fundsJSON);
                    // Se asegura de que la lista de fondos siempre esté ordenada con "Fondo Local" al principio.
                    // Esto corrige el problema para usuarios con datos guardados antes del cambio.
                    funds.sort((a, b) => {
                        if (a === 'Fondo Local') return -1;
                        if (b === 'Fondo Local') return 1;
                        return a.localeCompare(b);
                    });
                    return funds;
                } else {
                    // First time setup: combine default funds with any funds from existing entries for a smooth migration.
                    const existingEntries = getEntries();
                    const fundsFromEntries = existingEntries.map(entry => entry.fund);
                    // Use a Set to get unique values, and filter out any empty/null fund names.
                    const combinedFunds = [...new Set([...defaultFunds, ...fundsFromEntries])].filter(f => f);
                    
                    saveFunds(combinedFunds);
                    return combinedFunds;
                }
            };

            const saveFunds = (funds) => {
                // Siempre guardar ordenado alfabéticamente, pero manteniendo "Fondo Local" al principio.
                funds.sort((a, b) => {
                    if (a === 'Fondo Local') return -1;
                    if (b === 'Fondo Local') return 1;
                    return a.localeCompare(b);
                });
                localStorage.setItem('accountingFunds', JSON.stringify(funds));
            };

            const populateFundSelects = () => {
                const funds = getFunds();
                const currentFundValue = fundSelect.value;
                const currentFilterValue = fundFilter.value;

                fundSelect.innerHTML = '';
                fundFilter.innerHTML = '<option value="all">Todos los Fondos</option>';

                funds.forEach(fundName => {
                    const option = new Option(fundName, fundName);
                    fundSelect.add(option.cloneNode(true));
                    fundFilter.add(option.cloneNode(true));
                });

                // Restore previous selection if possible, otherwise default.
                fundSelect.value = funds.includes(currentFundValue) ? currentFundValue : (funds[0] || '');
                fundFilter.value = funds.includes(currentFilterValue) ? currentFilterValue : 'all';
            };

            const renderFundsList = () => {
                const fundsList = document.getElementById('funds-list');
                const funds = getFunds();
                fundsList.innerHTML = '';

                funds.forEach(fund => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item d-flex justify-content-between align-items-center';
                    li.dataset.fundName = fund;
                    li.innerHTML = `
                        <span class="fund-name">${fund}</span>
                        <div>
                            <button class="btn btn-warning btn-sm me-2" onclick="startFundEdit(this)">Editar</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteFund('${fund}')">Eliminar</button>
                        </div>
                    `;
                    fundsList.appendChild(li);
                });
            };

            manageFundsModalEl.addEventListener('show.bs.modal', () => {
                renderFundsList();
                document.getElementById('new-fund-name').value = '';
            });

            document.getElementById('add-fund-btn').addEventListener('click', () => {
                const newFundNameInput = document.getElementById('new-fund-name');
                const newName = newFundNameInput.value.trim();
                if (!newName) {
                    return alert('El nombre del fondo no puede estar vacío.');
                }

                const funds = getFunds();
                if (funds.map(f => f.toLowerCase()).includes(newName.toLowerCase())) {
                    return alert('Ya existe un fondo con este nombre.');
                }

                funds.push(newName);
                saveFunds(funds);
                newFundNameInput.value = '';
                populateFundSelects();
                renderFundsList();
                updateDisplay();
                alert(`Fondo "${newName}" añadido.`);
            });
            
            const formatNumber = (value) => {
                return new Intl.NumberFormat('es-CO', { minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(value);
            };


            const getEntries = () => {
                return JSON.parse(localStorage.getItem('accountingEntries')) || [];
            };

            const saveEntries = (entries) => {
                localStorage.setItem('accountingEntries', JSON.stringify(entries));
            };

            const calculateAndRenderTotals = (entries) => {
                let totalIncome = 0;
                let totalExpenses = 0;

                entries.forEach(entry => {
                    const amount = parseFloat(entry.amount);
                    if (entry.type === 'Ingreso') {
                        totalIncome += amount;
                    } else {
                        totalExpenses += amount;
                    }
                });

                const balance = totalIncome - totalExpenses;

                document.getElementById('total-income').textContent = `$${formatNumber(totalIncome)}`;
                document.getElementById('total-expenses').textContent = `$${formatNumber(totalExpenses)}`;
                
                const balanceEl = document.getElementById('total-balance');
                balanceEl.textContent = `$${formatNumber(balance)}`;
                
                const balanceCard = balanceEl.closest('.card');
                balanceCard.className = 'card text-white'; // Reset classes
                balanceCard.classList.add(balance >= 0 ? 'bg-primary' : 'bg-danger');
            };

            const renderEntries = (entries) => {
                historyTableBody.innerHTML = '';
                // Mostrar los más recientes primero
                entries.slice().reverse().forEach(entry => {
                    const row = document.createElement('tr');
                    
                    const typeClass = entry.type === 'Ingreso' ? 'text-success' : 'text-danger';
                    const sign = entry.type === 'Ingreso' ? '+' : '-';

                    row.innerHTML = `
                        <td>${entry.date}</td>
                        <td>${entry.receiptNumber || ''}</td>
                        <td>${entry.concept}</td>
                        <td>${entry.person || ''}</td>
                        <td><span class="fw-bold ${typeClass}">${entry.type}</span></td>
                        <td><span class="fw-bold ${typeClass}">${sign}$${formatNumber(parseFloat(entry.amount))}</span></td>
                        <td>${entry.fund}</td>
                        <td>
                            <div class="d-grid gap-1 d-sm-flex">
                                <button class="btn btn-sm btn-info" onclick="showReceiptById(${entry.id})" title="Ver Recibo">Recibo</button>
                                <button class="btn btn-sm btn-warning" onclick="startEdit(${entry.id})" title="Editar Asiento">Editar</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteEntry(${entry.id})" title="Eliminar Asiento">Eliminar</button>
                            </div>
                        </td>
                    `;
                    historyTableBody.appendChild(row);
                });
            };

            form.addEventListener('submit', (e) => {
                e.preventDefault();

                const editId = document.getElementById('edit-id').value;
                const entries = getEntries();

                const entryData = {
                    date: document.getElementById('date').value,
                    receiptNumber: document.getElementById('receipt-number').value,
                    concept: document.getElementById('concept').value,
                    person: document.getElementById('person').value,
                    type: document.getElementById('type').value,
                    amount: document.getElementById('amount').value,
                    fund: document.getElementById('fund').value,
                };

                if (editId) {
                    // Modo Edición
                    const entryIndex = entries.findIndex(e => e.id == editId);
                    if (entryIndex > -1) {
                        entries[entryIndex] = {
                            ...entries[entryIndex], // Conserva el ID original
                            ...entryData
                        };
                    }
                } else {
                    // Modo Agregar
                    const newEntry = {
                        id: Date.now(),
                        ...entryData
                    };
                    entries.push(newEntry);
                }

                saveEntries(entries);
                cancelEdit(); // Restablece el formulario y los botones
                updateDisplay(); // Actualiza toda la vista
            });

            const cancelEdit = () => {
                form.reset();
                document.getElementById('edit-id').value = '';
                formTitle.textContent = 'Nuevo Asiento Contable';
                formSubmitButton.textContent = 'Guardar Asiento';
                
                const cancelButton = document.getElementById('cancel-edit-btn');
                if (cancelButton) {
                    cancelButton.remove();
                }
            };

            window.startEdit = (id) => {
                const entries = getEntries();
                const entryToEdit = entries.find(e => e.id === id);
                if (!entryToEdit) return;

                // Rellenar el formulario
                document.getElementById('edit-id').value = entryToEdit.id;
                document.getElementById('date').value = entryToEdit.date;
                document.getElementById('receipt-number').value = entryToEdit.receiptNumber || '';
                document.getElementById('concept').value = entryToEdit.concept;
                document.getElementById('person').value = entryToEdit.person;
                document.getElementById('type').value = entryToEdit.type;
                document.getElementById('amount').value = entryToEdit.amount;
                document.getElementById('fund').value = entryToEdit.fund;

                // Actualizar la UI al modo edición
                formTitle.textContent = 'Editar Asiento Contable';
                formSubmitButton.textContent = 'Actualizar Asiento';
                
                if (!document.getElementById('cancel-edit-btn')) {
                    const cancelButton = document.createElement('button');
                    cancelButton.type = 'button';
                    cancelButton.id = 'cancel-edit-btn';
                    cancelButton.textContent = 'Cancelar';
                    cancelButton.className = 'btn btn-secondary ms-2';
                    cancelButton.onclick = cancelEdit;
                    formSubmitButton.after(cancelButton);
                }
                form.scrollIntoView({ behavior: 'smooth' });
            };

            window.startFundEdit = (buttonEl) => {
                const li = buttonEl.closest('li');
                const oldName = li.dataset.fundName;

                li.innerHTML = `
                    <input type="text" class="form-control form-control-sm" value="${oldName}">
                    <div class="btn-group">
                        <button class="btn btn-success btn-sm" onclick="saveFundEdit(this, '${oldName}')">Guardar</button>
                        <button class="btn btn-secondary btn-sm" onclick="renderFundsList()">Cancelar</button>
                    </div>
                `;
                li.querySelector('input').focus();
            };

            window.saveFundEdit = (buttonEl, oldName) => {
                const li = buttonEl.closest('li');
                const input = li.querySelector('input');
                const newName = input.value.trim();

                if (!newName || newName === oldName) {
                    renderFundsList();
                    return;
                }

                let funds = getFunds();
                if (funds.map(f => f.toLowerCase()).includes(newName.toLowerCase())) {
                    alert('Ya existe un fondo con este nombre.');
                    input.focus();
                    return;
                }

                funds = funds.map(f => (f === oldName ? newName : f));
                saveFunds(funds);

                let entries = getEntries();
                let updatedCount = 0;
                entries.forEach(entry => {
                    if (entry.fund === oldName) {
                        entry.fund = newName;
                        updatedCount++;
                    }
                });
                saveEntries(entries);

                alert(`Fondo "${oldName}" actualizado a "${newName}". Se actualizaron ${updatedCount} asientos.`);
                populateFundSelects();
                renderFundsList();
                updateDisplay();
            };

            window.deleteFund = (fundName) => {
                if (getFunds().length <= 1) { return alert('No se puede eliminar el último fondo.'); }
                if (getEntries().some(e => e.fund === fundName)) { return alert(`El fondo "${fundName}" está en uso y no puede ser eliminado.`); }

                if (confirm(`¿Estás seguro de que deseas eliminar el fondo "${fundName}"?`)) {
                    saveFunds(getFunds().filter(f => f !== fundName));
                    alert(`Fondo "${fundName}" eliminado.`);
                    populateFundSelects();
                    renderFundsList();
                    updateDisplay();
                }
            };

            window.deleteEntry = (id) => {
                if (confirm('¿Estás seguro de que deseas eliminar este asiento? Esta acción no se puede deshacer.')) {
                    let entries = getEntries();
                    const updatedEntries = entries.filter(e => e.id !== id);
                    saveEntries(updatedEntries);
                    updateDisplay();
                    // Opcional: cancelar edición si el asiento eliminado estaba siendo editado
                    if (document.getElementById('edit-id').value == id) {
                        cancelEdit();
                    }
                }
            };

            window.showReceiptById = (id) => {
                const entries = getEntries();
                const entry = entries.find(e => e.id === id);
                if (!entry) return;
                receiptContent.innerHTML = `
                    <div id="receipt-print-area">
                        <div class="receipt">
                            <div class="receipt-header">
                                <h2>RECIBO</h2>
                                <div class="d-flex justify-content-center text-muted small">
                                    <span class="me-4">ID de Transacción: ${entry.id}</span>
                                    ${entry.receiptNumber ? `<span>Nro. Recibo: <strong>${entry.receiptNumber}</strong></span>` : ''}
                                </div>
                            </div>
                            <div class="receipt-body">
                                <p><strong>Fecha:</strong> ${entry.date}</p>
                                <p><strong>Recibido de / Pagado a:</strong> ${entry.person || '_________________________'}</p>
                                <p><strong>Concepto:</strong> ${entry.concept}</p>
                                <p><strong>Tipo de Movimiento:</strong> ${entry.type}</p>
                                <p><strong>Monto:</strong> $${formatNumber(parseFloat(entry.amount))}</p>
                                <p><strong>Fondo Asignado:</strong> ${entry.fund}</p>
                                <br><br>
                                <div class="row mt-5">
                                    <div class="col-6 text-center">
                                        <p>_________________________</p>
                                        <p><strong>Firma Recibido</strong></p>
                                    </div>
                                    <div class="col-6 text-center">
                                        <p>_________________________</p>
                                        <p><strong>Firma Tesorero(a)</strong></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                receiptModal.show();
            };

            window.printContent = (elementId) => {
                const printArea = document.getElementById(elementId);
                if (!printArea) return;

                const parentModalBody = printArea.closest('.modal-body');
                if (parentModalBody) {
                    parentModalBody.classList.add('print-section');
                    window.print();
                    parentModalBody.classList.remove('print-section');
                }
            };

            window.exportToCSV = () => {
                const filteredEntries = getFilteredEntries();
                if (filteredEntries.length === 0) {
                    alert('No hay datos para exportar en la vista actual.');
                    return;
                }

                const headers = ['Fecha', 'Nro. Recibo', 'Concepto', 'Recibido de / Pagado a', 'Tipo', 'Monto', 'Fondo Asignado'];
                
                const escapeCSV = (value) => {
                    if (value === null || value === undefined) return '';
                    let str = String(value);
                    if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                        return `"${str.replace(/"/g, '""')}"`;
                    }
                    return str;
                };

                const csvRows = [
                    headers.join(','),
                    ...filteredEntries.map(e => [
                        e.date,
                        escapeCSV(e.receiptNumber),
                        escapeCSV(e.concept),
                        escapeCSV(e.person),
                        e.type,
                        e.amount,
                        escapeCSV(e.fund)
                    ].join(','))
                ];

                const csvContent = csvRows.join('\n');
                const blob = new Blob([`\uFEFF${csvContent}`], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'historial_contable.csv';
                link.click();
            };

            window.clearHistory = () => {
                const confirmation = confirm('¿Estás seguro de que deseas eliminar TODO el historial? Esta acción no se puede deshacer.');
                if (confirmation) {
                    saveEntries([]); // Guarda un array vacío, limpiando el historial
                    updateDisplay();
                    alert('El historial ha sido limpiado.');
                }
            };

            const getFilteredEntries = () => {
                let entries = getEntries();
                const selectedFund = fundFilter.value;
                const selectedType = typeFilter.value;

                if (selectedFund !== 'all') {
                    entries = entries.filter(e => e.fund === selectedFund);
                }
                if (selectedType !== 'all') {
                    entries = entries.filter(e => e.type === selectedType);
                }
                return entries;
            };

            const updateDisplay = () => {
                renderFundsDashboard(); // Se calcula primero con todos los datos
                const filteredEntries = getFilteredEntries();
                
                // Las funciones de renderizado ahora usan la lista de asientos ya filtrada
                renderEntries(filteredEntries);
                calculateAndRenderTotals(filteredEntries);
                updateTotalsTitle();
            };

            fundFilter.addEventListener('change', updateDisplay);
            typeFilter.addEventListener('change', updateDisplay);

            const renderFundsDashboard = () => {
                const fundsDashboardContainer = document.getElementById('funds-dashboard');
                if (!fundsDashboardContainer) return;

                const entries = getEntries();
                const fundOptions = getFunds();
                
                // Calculate balances for each fund
                const fundBalances = fundOptions.reduce((acc, fundName) => {
                    acc[fundName] = 0;
                    return acc;
                }, {});

                entries.forEach(entry => {
                    if (fundBalances.hasOwnProperty(entry.fund)) {
                        const amount = parseFloat(entry.amount) || 0;
                        if (entry.type === 'Ingreso') {
                            fundBalances[entry.fund] += amount;
                        } else {
                            fundBalances[entry.fund] -= amount;
                        }
                    }
                });

                fundsDashboardContainer.innerHTML = ''; // Clear previous content

                fundOptions.forEach(fundName => {
                    const balance = fundBalances[fundName];
                    const cardColor = balance >= 0 ? 'bg-light' : 'bg-warning text-dark';

                    const cardHtml = `
                        <div class="col-6 col-md-4 col-lg-3 mb-3">
                            <div class="card ${cardColor}">
                                <div class="card-body text-center p-2">
                                    <h6 class="card-title text-truncate mb-1" style="font-size: 0.9rem;" title="${fundName}">${fundName}</h6>
                                    <p class="card-text fs-5 fw-bold mb-0">$${formatNumber(balance)}</p>
                                </div>
                            </div>
                        </div>
                    `;
                    fundsDashboardContainer.insertAdjacentHTML('beforeend', cardHtml);
                });
            };

            // --- Lógica de Arqueo de Caja ---
            const denominations = [100000, 50000, 20000, 10000, 5000, 2000, 1000, 500, 200, 100, 50];

            const buildDenominationTable = () => {
                const tableBody = document.getElementById('denomination-table');
                tableBody.innerHTML = '';
                denominations.forEach(value => {
                    const row = document.createElement('tr');
                    const type = value >= 2000 ? 'Billete' : 'Moneda';
                    row.innerHTML = `
                        <td>${type} de $${formatNumber(value)}</td>
                        <td><input type="number" class="form-control form-control-sm denom-input" data-value="${value}" min="0" oninput="updateReconciliationTotals()"></td>
                        <td id="total-${String(value).replace('.', '_')}">$0</td>
                    `;
                    tableBody.appendChild(row);
                });
            };

            window.updateReconciliationTotals = () => {
                let physicalTotal = 0;
                document.querySelectorAll('.denom-input').forEach(input => {
                    const count = parseInt(input.value) || 0;
                    const value = parseFloat(input.dataset.value);
                    const subtotal = count * value;
                    physicalTotal += subtotal;
                    document.getElementById(`total-${String(value).replace('.', '_')}`).textContent = `$${formatNumber(subtotal)}`;
                });

                document.getElementById('physical-total').textContent = `$${formatNumber(physicalTotal)}`;

                const systemBalanceEl = document.getElementById('system-balance');
                const systemBalance = parseFloat(systemBalanceEl.dataset.rawBalance) || 0;
                
                const difference = physicalTotal - systemBalance;
                const differenceEl = document.getElementById('balance-difference');
                
                differenceEl.classList.remove('text-success', 'text-danger', 'text-primary');
                if (difference > 0) {
                    differenceEl.classList.add('text-success');
                    differenceEl.textContent = `$${formatNumber(difference)} (Sobrante)`;
                } else if (difference < 0) {
                    differenceEl.classList.add('text-danger');
                    differenceEl.textContent = `$${formatNumber(difference)} (Faltante)`;
                } else {
                    differenceEl.classList.add('text-primary');
                    differenceEl.textContent = `$${formatNumber(difference)} (Cuadra)`;
                }
            };

            window.openCashReconciliation = () => {
                const entries = getEntries();
                const localFundBalance = entries
                    .filter(e => e.fund === 'Fondo Local')
                    .reduce((acc, entry) => {
                        const amount = parseFloat(entry.amount) || 0;
                        return entry.type === 'Ingreso' ? acc + amount : acc - amount;
                    }, 0);

                const systemBalanceEl = document.getElementById('system-balance');
                systemBalanceEl.textContent = `$${formatNumber(localFundBalance)}`;
                systemBalanceEl.dataset.rawBalance = localFundBalance;
                
                // Resetear campos
                document.querySelectorAll('.denom-input').forEach(input => input.value = '');
                updateReconciliationTotals();
                
                cashReconciliationModal.show();
            };

            // Carga inicial de datos
            const applyTheme = (theme) => {
                if (theme === 'dark') {
                    body.classList.add('dark-mode');
                    themeToggle.textContent = 'Cambiar a Modo Día';
                } else {
                    body.classList.remove('dark-mode');
                    themeToggle.textContent = 'Cambiar a Modo Noche';
                }
            };

            themeToggle.addEventListener('click', (e) => {
                const currentTheme = body.classList.contains('dark-mode') ? 'light' : 'dark';
                localStorage.setItem('theme', currentTheme);
                applyTheme(currentTheme);
            });

            // Cargar tema guardado o usar 'light' por defecto
            const savedTheme = localStorage.getItem('theme') || 'light';
            applyTheme(savedTheme);

            populateFundSelects();
            buildDenominationTable();
            updateDisplay();
        });
    </script>
</body>
</html>
